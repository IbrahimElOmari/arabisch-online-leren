name: Database Backup

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual triggering

env:
  SUPABASE_PROJECT_ID: xugosdedyukizseveahx
  BACKUP_RETENTION_DAYS: 30

jobs:
  backup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Create backup directory
        run: mkdir -p backups

      - name: Generate backup filename
        id: backup-filename
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          FILENAME="backup_${TIMESTAMP}.sql"
          echo "filename=${FILENAME}" >> $GITHUB_OUTPUT
          echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT

      - name: Create database backup
        env:
          PGPASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          pg_dump \
            --host=aws-0-eu-central-1.pooler.supabase.com \
            --port=6543 \
            --username=postgres.xugosdedyukizseveahx \
            --dbname=postgres \
            --format=custom \
            --no-owner \
            --no-privileges \
            --file=backups/${{ steps.backup-filename.outputs.filename }}

      - name: Compress backup
        run: |
          gzip backups/${{ steps.backup-filename.outputs.filename }}

      - name: Upload backup to artifacts
        uses: actions/upload-artifact@v4
        with:
          name: database-backup-${{ steps.backup-filename.outputs.timestamp }}
          path: backups/${{ steps.backup-filename.outputs.filename }}.gz
          retention-days: ${{ env.BACKUP_RETENTION_DAYS }}

      - name: Log backup to Supabase
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          BACKUP_SIZE=$(stat -f%z "backups/${{ steps.backup-filename.outputs.filename }}.gz" || stat -c%s "backups/${{ steps.backup-filename.outputs.filename }}.gz")
          
          curl -X POST "${SUPABASE_URL}/rest/v1/backup_jobs" \
            -H "apikey: ${SUPABASE_SERVICE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_KEY}" \
            -H "Content-Type: application/json" \
            -d '{
              "status": "completed",
              "artifact_url": "github-actions://artifacts/database-backup-${{ steps.backup-filename.outputs.timestamp }}",
              "note": "Automated backup via GitHub Actions",
              "finished_at": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'"
            }'

      - name: Notify on failure
        if: failure()
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          curl -X POST "${SUPABASE_URL}/rest/v1/backup_jobs" \
            -H "apikey: ${SUPABASE_SERVICE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_KEY}" \
            -H "Content-Type: application/json" \
            -d '{
              "status": "failed",
              "note": "Backup failed - check GitHub Actions logs"
            }'

  cleanup-old-backups:
    runs-on: ubuntu-latest
    needs: backup
    
    steps:
      - name: Delete old backup artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const retentionDays = parseInt(process.env.BACKUP_RETENTION_DAYS);
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - retentionDays);

            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            for (const artifact of artifacts.data.artifacts) {
              if (artifact.name.startsWith('database-backup-')) {
                const artifactDate = new Date(artifact.created_at);
                if (artifactDate < cutoffDate) {
                  console.log(`Deleting old artifact: ${artifact.name}`);
                  await github.rest.actions.deleteArtifact({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    artifact_id: artifact.id
                  });
                }
              }
            }
